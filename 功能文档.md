# 分布式任务调度系统 - 详细功能文档

## 1. 系统概述

### 1.1 项目简介
本系统是一个基于 Go 语言开发的分布式任务调度系统，支持多实例部署、灵活的负载均衡策略和完善的任务管理功能。系统采用微服务架构，通过 RESTful API 提供服务，支持 Web UI 管理界面。

### 1.2 核心特性
- **分布式调度**：支持多调度器实例，通过分布式锁实现主从选举
- **灵活的负载均衡**：提供 5 种负载均衡策略
- **多种执行模式**：支持并行、串行、跳过三种执行模式
- **健康检查机制**：自动检测执行器状态，确保系统可靠性
- **完善的监控**：提供详细的执行统计和健康度指标
- **Web UI 管理**：基于 Next.js 的现代化管理界面

### 1.3 技术栈
- **后端**：Go 1.23+、Gin、GORM、Cron、Zap
- **前端**：Next.js 15+、React 19、TypeScript、Tailwind CSS
- **数据库**：MySQL 8.0+
- **部署**：Docker、Docker Compose

## 2. 系统架构

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web UI        │    │   API Gateway   │    │   Scheduler     │
│   (Next.js)     │◄──►│   (Gin)         │◄──►│   (Leader)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                │                       │
                                ▼                       ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   MySQL         │    │   Executor      │
                       │   Database      │    │   Cluster       │
                       └─────────────────┘    └─────────────────┘
```

### 2.2 核心模块

#### 2.2.1 调度器模块 (Scheduler)
- **文件位置**：`internal/scheduler/`
- **主要功能**：
  - 任务调度管理，基于 Cron 表达式定时触发
  - 分布式锁实现主从选举（使用 MySQL GET_LOCK）
  - 任务执行状态监控和管理
  - 支持手动触发任务

#### 2.2.2 执行器管理模块 (Executor Manager)
- **文件位置**：`internal/executor/`
- **主要功能**：
  - 执行器注册和注销管理
  - 执行器状态维护（online/offline/maintenance）
  - 健康检查机制（30秒间隔）
  - 执行器负载统计

#### 2.2.3 负载均衡模块 (Load Balancer)
- **文件位置**：`internal/loadbalance/`
- **支持策略**：
  1. **Round Robin**：轮询分配
  2. **Weighted Round Robin**：加权轮询
  3. **Random**：随机分配
  4. **Sticky**：粘性会话
  5. **Least Loaded**：最少负载优先
- **状态持久化**：所有策略状态保存到数据库

#### 2.2.4 API 服务模块
- **文件位置**：`internal/api/`
- **技术栈**：基于 Gin 框架
- **功能特性**：
  - RESTful API 设计
  - CORS 支持，便于前端集成
  - 错误处理和日志记录中间件
  - 分页查询支持

#### 2.2.5 存储层模块
- **文件位置**：`internal/storage/`
- **技术实现**：基于 GORM 的数据持久层
- **主要功能**：
  - 数据库连接管理
  - 数据访问对象（DAO）封装
  - 事务管理支持

## 3. 数据模型设计

### 3.1 核心数据表

#### 3.1.1 tasks - 任务定义表
```sql
CREATE TABLE tasks (
    id VARCHAR(64) PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE,
    cron_expression VARCHAR(100) NOT NULL,
    parameters JSON,
    execution_mode ENUM('sequential','parallel','skip') DEFAULT 'parallel',
    load_balance_strategy ENUM('round_robin','weighted_round_robin','random','sticky','least_loaded') DEFAULT 'round_robin',
    max_retry INT DEFAULT 3,
    timeout_seconds INT DEFAULT 300,
    status ENUM('active','paused','deleted') DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 3.1.2 executors - 执行器实例表
```sql
CREATE TABLE executors (
    id VARCHAR(64) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    instance_id VARCHAR(255) NOT NULL UNIQUE,
    base_url VARCHAR(500) NOT NULL,
    health_check_url VARCHAR(500),
    status ENUM('online','offline','maintenance') DEFAULT 'online',
    is_healthy BOOLEAN DEFAULT TRUE,
    last_health_check TIMESTAMP,
    health_check_failures INT DEFAULT 0,
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 3.1.3 task_executions - 任务执行历史表
```sql
CREATE TABLE task_executions (
    id VARCHAR(64) PRIMARY KEY,
    task_id VARCHAR(64) NOT NULL,
    executor_id VARCHAR(64),
    scheduled_time TIMESTAMP NOT NULL,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    status ENUM('pending','running','success','failed','timeout','skipped','cancelled') DEFAULT 'pending',
    result JSON,
    logs TEXT,
    retry_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (executor_id) REFERENCES executors(id) ON DELETE SET NULL
);
```

### 3.2 关联关系表

#### 3.2.1 task_executors - 任务执行器关联表
- 定义任务与执行器的多对多关系
- 支持权重和优先级配置
- 用于负载均衡策略计算

#### 3.2.2 load_balance_state - 负载均衡状态表
- 存储各种负载均衡策略的状态信息
- 支持轮询索引、粘性会话等状态持久化

#### 3.2.3 scheduler_instances - 调度器实例表
- 记录调度器实例信息
- 支持分布式环境下的实例管理和领导选举

## 4. 核心功能详解

### 4.1 任务管理功能

#### 4.1.1 任务创建
- **接口**：`POST /api/v1/tasks`
- **功能**：创建新的定时任务
- **参数配置**：
  - 任务名称（唯一约束）
  - Cron 表达式（支持秒级精度）
  - 执行模式选择
  - 负载均衡策略
  - 重试次数和超时配置
- **验证机制**：
  - Cron 表达式格式验证
  - 任务名称唯一性检查
  - 参数合法性验证

#### 4.1.2 任务编辑和更新
- **接口**：`PUT /api/v1/tasks/{id}`
- **支持字段**：
  - 任务基本信息更新
  - 调度参数修改
  - 状态变更（激活/暂停）
- **生效机制**：修改后自动重载调度器配置

#### 4.1.3 任务状态管理
- **激活状态**：正常参与调度
- **暂停状态**：停止调度但保留配置
- **删除状态**：软删除，不参与调度

#### 4.1.4 手动触发
- **接口**：`POST /api/v1/tasks/{id}/trigger`
- **功能**：
  - 立即执行指定任务
  - 支持运行时参数覆盖
  - 绕过执行模式限制

### 4.2 执行器管理功能

#### 4.2.1 执行器注册
- **接口**：`POST /api/v1/executors/register`
- **注册信息**：
  - 执行器名称和实例ID
  - 服务地址和健康检查端点
  - 元数据信息（可选）
- **自动功能**：
  - 注册后立即启动健康检查
  - 自动发现和状态同步

#### 4.2.2 健康检查机制
- **检查频率**：30秒间隔
- **检查方式**：HTTP GET 请求健康检查端点
- **失败处理**：
  - 连续失败3次标记为不健康
  - 连续成功2次恢复健康状态
- **状态影响**：不健康的执行器不参与任务分配

#### 4.2.3 状态管理
- **在线状态**：正常工作，参与任务分配
- **离线状态**：暂时不可用，不参与分配
- **维护状态**：手动设置，用于系统维护

### 4.3 执行模式功能

#### 4.3.1 并行模式 (Parallel)
- **行为**：允许同一任务的多个实例同时执行
- **适用场景**：数据处理、批量操作等
- **资源考虑**：需要考虑系统资源和执行器负载

#### 4.3.2 串行模式 (Sequential)
- **行为**：确保同一任务在任何时刻只有一个实例在执行
- **实现机制**：
  - 执行前检查是否有运行中或待执行的实例
  - 有则跳过本次调度
- **适用场景**：数据同步、状态修改等需要顺序执行的任务

#### 4.3.3 跳过模式 (Skip)
- **行为**：如果有实例在执行，则跳过本次调度并记录
- **记录机制**：创建状态为"skipped"的执行记录
- **适用场景**：监控类任务，避免重复执行

### 4.4 负载均衡功能

#### 4.4.1 轮询策略 (Round Robin)
- **算法**：按顺序依次分配任务给执行器
- **状态维护**：记录当前轮询位置
- **公平性**：保证每个执行器获得相同的任务数量

#### 4.4.2 加权轮询 (Weighted Round Robin)
- **算法**：根据执行器权重按比例分配任务
- **权重设置**：在任务-执行器关联中配置
- **适用场景**：执行器性能差异较大的环境

#### 4.4.3 随机策略 (Random)
- **算法**：随机选择可用执行器
- **特点**：简单高效，适合同质化执行器环境
- **负载分布**：长期趋于均匀

#### 4.4.4 粘性会话 (Sticky)
- **算法**：尽可能将同一任务分配给相同执行器
- **状态维护**：记录任务与执行器的绑定关系
- **适用场景**：有状态任务或需要本地缓存的场景

#### 4.4.5 最少负载 (Least Loaded)
- **算法**：选择当前正在执行任务数最少的执行器
- **实时统计**：基于数据库中的执行状态统计
- **性能优化**：通过索引和缓存提升查询性能

### 4.5 监控和统计功能

#### 4.5.1 执行历史记录
- **完整追踪**：记录任务从调度到完成的全过程
- **详细信息**：
  - 调度时间、开始时间、结束时间
  - 执行状态、结果数据、错误日志
  - 重试次数、执行器信息
- **分页查询**：支持大量历史数据的高效查询

#### 4.5.2 任务统计分析
- **成功率统计**：24小时、7天、90天不同维度
- **执行趋势**：每日执行次数和成功率变化
- **健康度评分**：综合成功率和超时率的健康指标
- **性能指标**：平均执行时间、超时次数等

#### 4.5.3 系统状态监控
- **调度器状态**：实例列表、领导者信息
- **执行器状态**：在线数量、健康状况
- **实时统计**：当前运行任务数、待执行任务数

## 5. API 接口文档

### 5.1 任务管理接口

#### 创建任务
```http
POST /api/v1/tasks
Content-Type: application/json

{
  "name": "data_sync_task",
  "cron_expression": "0 */5 * * * *",
  "execution_mode": "sequential",
  "load_balance_strategy": "round_robin",
  "max_retry": 3,
  "timeout_seconds": 600,
  "parameters": {
    "source": "database_a",
    "target": "database_b"
  }
}
```

#### 获取任务列表
```http
GET /api/v1/tasks?status=active&page=1&page_size=20
```

#### 手动触发任务
```http
POST /api/v1/tasks/{task_id}/trigger
Content-Type: application/json

{
  "parameters": {
    "force_sync": true
  }
}
```

#### 暂停/恢复任务
```http
POST /api/v1/tasks/{task_id}/pause
POST /api/v1/tasks/{task_id}/resume
```

### 5.2 执行器管理接口

#### 注册执行器
```http
POST /api/v1/executors/register
Content-Type: application/json

{
  "name": "data-processor",
  "instance_id": "dp-001",
  "base_url": "http://192.168.1.100:9090",
  "health_check_url": "http://192.168.1.100:9090/health",
  "metadata": {
    "region": "us-west-1",
    "capacity": 10
  }
}
```

#### 更新执行器状态
```http
PUT /api/v1/executors/{executor_id}/status
Content-Type: application/json

{
  "status": "maintenance",
  "reason": "System maintenance"
}
```

### 5.3 执行历史接口

#### 获取执行历史
```http
GET /api/v1/executions?task_id={task_id}&status=success&page=1&page_size=50
```

#### 停止正在执行的任务
```http
POST /api/v1/executions/{execution_id}/stop
```

#### 执行回调接口
```http
POST /api/v1/executions/{execution_id}/callback
Content-Type: application/json

{
  "status": "success",
  "result": {
    "processed_records": 1000,
    "duration": 120
  },
  "logs": "Task completed successfully",
  "end_time": "2024-01-01T12:00:00Z"
}
```

## 6. Web UI 功能

### 6.1 界面结构
- **响应式设计**：支持桌面和移动设备
- **现代化 UI**：基于 Tailwind CSS 的简洁设计
- **实时更新**：自动刷新状态和统计数据

### 6.2 主要页面

#### 6.2.1 任务管理页面
- 任务列表展示和筛选
- 创建和编辑任务表单
- 任务状态操作（启动/暂停/删除）
- 手动触发和参数设置

#### 6.2.2 执行器管理页面
- 执行器状态监控
- 注册新执行器
- 执行器信息编辑
- 健康检查状态查看

#### 6.2.3 执行历史页面
- 历史记录分页浏览
- 多维度筛选查询
- 执行详情查看
- 日志和结果展示

#### 6.2.4 监控统计页面
- 系统整体状态概览
- 任务执行统计图表
- 执行器负载分布
- 健康度趋势分析

## 7. 部署和配置

### 7.1 环境要求
- **Go 版本**：1.23.0+
- **Node.js 版本**：18.0+
- **MySQL 版本**：8.0+
- **操作系统**：Linux/macOS/Windows

### 7.2 配置文件
主配置文件位于 `configs/config.yaml`：

```yaml
database:
  host: "127.0.0.1"
  port: 3306
  user: "root"
  password: "123456"
  dbname: "jobs"
  
api:
  port: 8080
  
scheduler:
  instance_id: "scheduler-001"
  heartbeat_interval: "30s"
  lock_key: "scheduler_leader_lock"
  lock_timeout: "30s"
  max_workers: 10
  
health_check:
  interval: "30s"
  timeout: "10s"
  failure_threshold: 3
  recovery_threshold: 2
```

### 7.3 Docker 部署
```bash
# 构建镜像
make docker-build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f scheduler
```

### 7.4 常用命令
```bash
# 构建和运行
make build && make run

# 开发模式（热重载）
make dev

# 运行测试
make test

# 数据库迁移
make migrate

# 代码格式化和检查
make fmt && make lint
```

## 8. 扩展和维护

### 8.1 系统扩展
- **水平扩展**：支持多调度器实例部署
- **执行器扩展**：动态添加执行器节点
- **负载均衡扩展**：支持自定义负载均衡策略
- **存储扩展**：支持 MySQL 主从复制和分库分表

### 8.2 监控和告警
- **日志记录**：基于 Zap 的结构化日志
- **指标收集**：支持 Prometheus 集成
- **健康检查**：内置健康检查端点
- **告警机制**：可集成第三方告警系统

### 8.3 安全考虑
- **API 认证**：支持 JWT 令牌认证
- **HTTPS 支持**：生产环境建议启用 HTTPS
- **数据库安全**：使用连接池和预编译语句
- **日志脱敏**：避免敏感信息泄露

### 8.4 性能优化
- **数据库优化**：合理的索引设计和查询优化
- **连接池管理**：数据库和 HTTP 连接池配置
- **缓存机制**：执行器状态和负载均衡状态缓存
- **异步处理**：任务执行和回调处理异步化

## 9. 故障处理

### 9.1 常见问题
- **数据库连接失败**：检查配置和网络连接
- **执行器健康检查失败**：验证执行器服务状态
- **任务执行超时**：调整超时配置或优化任务逻辑
- **分布式锁竞争**：检查调度器实例配置

### 9.2 日志分析
- **调度器日志**：`scheduler.log`
- **执行器日志**：`executor.log`
- **API 访问日志**：Gin 框架日志
- **数据库日志**：MySQL 慢查询和错误日志

### 9.3 故障恢复
- **数据备份**：定期备份数据库
- **状态恢复**：系统重启后自动恢复调度状态
- **任务补偿**：失败任务的重试和补偿机制
- **回滚机制**：配置变更的回滚功能

这个功能文档详细介绍了分布式任务调度系统的各个方面，从系统概述到具体功能实现，再到部署维护，为开发者和运维人员提供了全面的技术指导。